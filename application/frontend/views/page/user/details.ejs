<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<div class="container-fluid d-flex justify-content-between align-items-start bg-dark text-light p-5">
  <div class="gap-1">
    <img src="/static/pormil2.png" style="filter: saturate();" width="40" alt="">
    <h3 class="text-nowrap  text-capitalize font-bold">Por Mil </h3>
  </div>
  <div class="text-right" hx-get="/component/user" hx-trigger="load delay:400ms" hx-swap="innerHTML">
  </div>
</div>
<div class="container-fluid px-5 py-3">
  <a href="/?userId=<%= userId %>" class="btn btn-secondary mb-5">
    <i class="bi-arrow-left"></i> Voltar
  </a>
  <div class="d-flex justify-content-around">
    <div hx-get="/component/user-form?onlyView=true" hx-trigger="load" hx-swap="outerHTML"></div>
    <form id="changePasswordForm" name="changePassword">
      <h1>Mudar senha</h1>
      <div class="form-group">
        <label for="currentPassword">Insira a senha atual</label>
        <input autocomplete="false" type="password" id="currentPassword" name="currentPassword" class="form-control" required>
      </div>
      <div class="form-group">
        <label for="password">Insira a nova senha</label>
        <input autocomplete="false" type="password" id="password" name="password" class="form-control" required>
      </div>
      <div class="form-group">
        <label for="password2">Confirme a nova senha</label>
        <input autocomplete="false" type="password" id="password2" name="password2" class="form-control" required>
      </div>
      <div class="d-flex align-items-center justify-content-between">
        <button type="submit" class="btn btn-primary btn-block mt-3">Enviar</button>
      </div>
    </form>
    <script>
      document.forms["changePassword"].addEventListener('submit', forgotPassword);
      /** 
       * @param {SubmitEvent} event   
       */
      async function forgotPassword(event) {
        event.preventDefault();
        const currentPassword = document.querySelector('#currentPassword').value;
        const password = document.querySelector('#password').value;
        const password2 = document.querySelector('#password2').value;

        if (password !== password2) {
          return Toastify({
            text: 'As senhas não são iguais',
            duration: 3000,
            close: true,
            gravity: 'top',
            position: 'right',
            backgroundColor: '#DD0000',
          }).showToast();
        }

        const data = {
          currentPassword,
          password
        };
        fetch(`${env.API_URL}/auth/change-password/<%= user.email %>`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
          .then(response => {
            if (response.status == 200) {
              Toastify({
                text: 'Senha alterada com sucesso',
                duration: 3000,
                close: true,
                gravity: 'top',
                position: 'right',
                backgroundColor: '#00b09b',
              }).showToast();

              setTimeout(() => {
                window.location.href = '/';
              }, 3000);
              return;
            }
            let message = ''
            switch (response.status) {
              case 404:
                message = 'Usuário não encontrado'
                break;
              case 406:
                message = 'Senha atual incorreta'
                break;
              default:
                message = 'Falha ao tentar alterar a senha'
                break;
            }

            Toastify({
              text: message,
              duration: 3000,
              close: true,
              gravity: 'top',
              position: 'right',
              backgroundColor: '#ff0000',
            }).showToast();
          });
      }
    </script>
  </div>
</div>